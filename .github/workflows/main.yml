name: Android Fix - Final
on: workflow_dispatch

jobs:
  run-android:
    runs-on: ubuntu-latest
    env:
      ANDROID_AVD_HOME: /home/runner/.android/avd # Forces tools to find the device
    steps:
      - uses: actions/checkout@v4

      - name: üåê Connect Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}

      - name: üõ†Ô∏è Install Ubuntu Desktop Tools
        run: sudo apt-get update && sudo apt-get install -y xvfb x11vnc fluxbox wmctrl

      - name: üì± Setup SDK
        uses: android-actions/setup-android@v3

      - name: ‚ö° Build & Launch Android
        run: |
          # 1. Force directories
          mkdir -p $ANDROID_AVD_HOME
          
          # 2. Use Android 9 (API 28) - fastest/most stable for cloud
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "system-images;android-28;default;x86_64"
          echo "no" | $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager create avd -n vbox_style -k "system-images;android-28;default;x86_64" --force
          
          # 3. Start Display
          Xvfb :99 -screen 0 720x1280x16 &
          export DISPLAY=:99
          sleep 5
          fluxbox &

          # 4. Launch with Cloud-Safe Graphics
          $ANDROID_HOME/emulator/emulator -avd vbox_style \
            -no-audio \
            -no-boot-anim \
            -gpu swiftshader_indirect \
            -no-snapshot \
            -memory 2048 &

          # 5. Wait for the window to appear and bring it to front
          sleep 30
          wmctrl -r "Android Emulator" -e 0,0,0,720,1280 || true

      - name: üîí VNC Connect
        run: |
          mkdir -p ~/.vnc
          x11vnc -storepasswd "android123" ~/.vnc/passwd
          export DISPLAY=:99
          x11vnc -rfbauth ~/.vnc/passwd -display :99 -forever -bg -rfbport 5900
          
          echo "=========================================="
          echo "  IP: $(tailscale ip -4)"
          echo "  PASS: android123"
          echo "=========================================="
          
          # Check boot status via ADB
          $ANDROID_HOME/platform-tools/adb wait-for-device
          echo "Device detected. Loading Home Screen..."
          sleep 60 # Give the UI time to draw
          sleep 3600

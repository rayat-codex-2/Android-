name: Redroid Stable Android
on: workflow_dispatch

jobs:
  android:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸŒ Connect Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
          args: --hostname=redroid-runner

      - name: ğŸ³ Start Redroid (Android 11)
        run: |
          # 1. Install necessary kernel modules for Ubuntu
          sudo apt-get update
          sudo apt-get install -y linux-modules-extra-$(uname -r)
          sudo modprobe binder_linux devices="binder,hwbinder,vndbinder"
          sudo modprobe ashmem_linux || true

          # 2. Start Redroid Container (The Android Core)
          docker run -d --privileged \
            --name redroid \
            -p 5555:5555 \
            redroid/redroid:11.0.0-latest \
            androidboot.redroid_width=720 \
            androidboot.redroid_height=1280 \
            androidboot.redroid_fps=30

          # 3. Start VNC Bridge (So you can see it)
          docker run -d --privileged \
            --name vnc-bridge \
            --link redroid:redroid \
            -p 5900:5900 \
            -e VNC_PASSWORD=android123 \
            -e REMOTE_HOST=redroid \
            -e REMOTE_PORT=5555 \
            -v /var/run/docker.sock:/var/run/docker.sock \
            softethervpn/vpnserver:latest || echo "Starting VNC bridge..."
          
          # Alternative: Using a standard android-vbox style setup if Docker fails
          # But let's stick to Redroid for stability.

      - name: ğŸ”’ Connection Info
        run: |
          echo "Waiting 2 minutes for Android to boot..."
          sleep 120
          
          TS_IP=$(tailscale ip -4)
          echo "=========================================="
          echo "âœ… REDROID IS BOOTING"
          echo "ğŸŒ IP: $TS_IP"
          echo "ğŸ”Œ Port: 5900"
          echo "ğŸ”‘ Pass: android123"
          echo "=========================================="
          
          sleep 3600

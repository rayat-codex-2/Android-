name: Android Remote VNC (Auth Key)
on: workflow_dispatch

jobs:
  emulator:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: üåê Connect Tailscale (Auth Key)
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}

      - name: üõ†Ô∏è Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb x11vnc fluxbox

      - name: üì± Setup & Launch Emulator
        run: |
          # Setup SDK
          sdkmanager "system-images;android-29;default;x86_64"
          echo "no" | avdmanager create avd -n fast_emu -k "system-images;android-29;default;x86_64" --force
          
          # Start Virtual Screen
          Xvfb :99 -screen 0 1280x720x16 &
          export DISPLAY=:99
          fluxbox & 

          # Launch Android (The 'fast' way)
          $ANDROID_HOME/emulator/emulator -avd fast_emu \
            -no-audio -no-boot-anim -accel on -gpu swiftshader_indirect -memory 2048 &

      - name: üîí Start VNC & Show Credentials
        run: |
          # Set VNC Password
          mkdir -p ~/.vnc
          x11vnc -storepasswd "android123" ~/.vnc/passwd
          
          # Start Server
          export DISPLAY=:99
          x11vnc -rfbauth ~/.vnc/passwd -display :99 -forever -bg -rfbport 5900
          
          # Get Connection Info
          TS_IP=$(tailscale ip -4)
          echo "=========================================="
          echo "  IP ADDRESS : $TS_IP"
          echo "  USERNAME   : runner"
          echo "  PASSWORD   : android123"
          echo "  PORT       : 5900"
          echo "=========================================="
          
          # Stay alive
          sleep 3600

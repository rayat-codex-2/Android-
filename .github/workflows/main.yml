name: Android Remote VNC (Phone Optimized)
on: workflow_dispatch

jobs:
  emulator:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: üåê Connect Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}

      - name: üõ†Ô∏è Install VNC & Display Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb x11vnc fluxbox wmctrl

      - name: üì± Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: ‚ö° Launch Visible Emulator
        run: |
          # 1. Paths
          SDK_MANAGER=$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager
          AVD_MANAGER=$ANDROID_HOME/cmdline-tools/latest/bin/avdmanager
          EMULATOR=$ANDROID_HOME/emulator/emulator
          
          if [ ! -f "$SDK_MANAGER" ]; then
            SDK_MANAGER=$ANDROID_HOME/tools/bin/sdkmanager
            AVD_MANAGER=$ANDROID_HOME/tools/bin/avdmanager
          fi

          # 2. Use Android 9 (API 28) - It is much more stable on GitHub Actions
          $SDK_MANAGER "system-images;android-28;default;x86_64"
          echo "no" | $AVD_MANAGER create avd -n phone_emu -k "system-images;android-28;default;x86_64" --force
          
          # 3. Setup Virtual Screen (Standard Phone Aspect Ratio)
          Xvfb :99 -screen 0 720x1280x16 &
          export DISPLAY=:99
          sleep 3
          fluxbox & 

          # 4. Launch with "Guest" rendering (Slow but guaranteed to show up)
          $EMULATOR -avd phone_emu \
            -no-audio \
            -no-boot-anim \
            -gpu guest \
            -no-snapshot \
            -memory 2048 \
            -qemu -m 2048 &
          
          # 5. Force window to front
          sleep 15
          wmctrl -r "Android Emulator" -e 0,0,0,720,1280 || true

      - name: üîí Start VNC & Connection Info
        run: |
          mkdir -p ~/.vnc
          x11vnc -storepasswd "android123" ~/.vnc/passwd
          export DISPLAY=:99
          x11vnc -rfbauth ~/.vnc/passwd -display :99 -forever -bg -rfbport 5900
          
          TS_IP=$(tailscale ip -4)
          echo "=========================================="
          echo "üåê IP: $TS_IP"
          echo "üîë PASS: android123"
          echo "=========================================="
          
          # Wait for Android to actually finish loading
          $ANDROID_HOME/platform-tools/adb wait-for-device
          echo "Device found! Waiting for UI..."
          sleep 60
          echo "The screen should no longer be black/empty."
          
          sleep 3600
          

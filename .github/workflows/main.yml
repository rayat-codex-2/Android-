name: Stable macOS Android
on: workflow_dispatch

jobs:
  android-vbox:
    runs-on: macos-13
    timeout-minutes: 60  # Prevents early auto-cancellation
    steps:
      - name: ğŸŒ Tailscale (Manual & Verified)
        continue-on-error: true  # If Tailscale fails, the job won't stop immediately
        run: |
          brew install tailscale
          sudo tailscaled --tun=userspace-networking &
          sleep 10
          # We use --reset to clear any old sessions that cause crashes
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --reset --hostname=gh-mac-vbox

      - name: ğŸ’¿ Download Android (SourceForge)
        run: |
          curl -L -o android.iso "https://sourceforge.net/projects/android-x86/files/Release%209.0/android-x86_64-9.0-r2.iso/download"

      - name: ğŸ—ï¸ Setup VM (Low Memory Mode)
        run: |
          VBoxManage createvm --name "AndroidVM" --ostype "Linux26_64" --register
          # Reduced to 2048MB to prevent the runner from crashing/canceling
          VBoxManage modifyvm "AndroidVM" --memory 2048 --vram 128 --nic1 nat --graphicscontroller vmsvga
          
          VBoxManage storagectl "AndroidVM" --name "SATA" --add sata
          VBoxManage storageattach "AndroidVM" --storagectl "SATA" --port 0 --device 0 --type dvddrive --medium android.iso
          
          VBoxManage modifyvm "AndroidVM" --vrde on --vrdeport 5900 --vrdeaddress 0.0.0.0

      - name: ğŸš€ Launch & Keep Alive
        run: |
          VBoxManage startvm "AndroidVM" --type headless
          
          TS_IP=$(tailscale ip -4 || echo "IP_NOT_FOUND")
          echo "=========================================="
          echo "ğŸŒ TAILSCALE IP: $TS_IP"
          echo "ğŸ”Œ PORT: 5900"
          echo "=========================================="
          
          # This loop prevents GitHub from thinking the job is idle
          for i in {1..60}; do
            echo "Runner still active... Minute $i"
            sleep 360
          done

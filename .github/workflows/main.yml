name: macOS VirtualBox Android (Fixed)
on: workflow_dispatch

jobs:
  android-vbox:
    runs-on: macos-13  # Must use Intel-based macOS for VirtualBox
    steps:
      - name: üåê Manual Tailscale Setup
        run: |
          # Install Tailscale via Brew to bypass the Linux-only action check
          brew install tailscale
          sudo tailscaled --tun=userspace-networking &
          sleep 5
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --hostname=gh-macos-vbox

      - name: üíø Download Android ISO (SourceForge Mirror)
        run: |
          # Using SourceForge as OSDN is currently unreliable
          curl -L -o android.iso "https://sourceforge.net/projects/android-x86/files/Release%209.0/android-x86_64-9.0-r2.iso/download"

      - name: üèóÔ∏è Setup VirtualBox VM
        run: |
          # Create and configure the VM
          VBoxManage createvm --name "AndroidVM" --ostype "Linux26_64" --register
          VBoxManage modifyvm "AndroidVM" --memory 3072 --vram 128 --nic1 nat --graphicscontroller vmsvga
          
          # Attach Storage
          VBoxManage storagectl "AndroidVM" --name "SATA" --add sata
          VBoxManage storageattach "AndroidVM" --storagectl "SATA" --port 0 --device 0 --type dvddrive --medium android.iso
          
          # Enable Remote Desktop (VRDE) on Port 5900
          VBoxManage modifyvm "AndroidVM" --vrde on --vrdeport 5900 --vrdeaddress 0.0.0.0

      - name: üöÄ Launch & Connection Info
        run: |
          VBoxManage startvm "AndroidVM" --type headless
          
          TS_IP=$(tailscale ip -4)
          echo "===================================================="
          echo "üåê TAILSCALE IP: $TS_IP"
          echo "üîå PORT: 5900"
          echo "üîë PASSWORD: (None/Blank)"
          echo "===================================================="
          echo "‚ö†Ô∏è  STEPS TO SEE ANDROID:"
          echo "1. Connect your VNC/RDP app to $TS_IP:5900"
          echo "2. You will see a Boot Menu."
          echo "3. Use your keyboard to select 'Live CD - Run Android-x86'"
          echo "4. Wait 5-10 minutes for it to boot."
          echo "===================================================="
          
          sleep 3600

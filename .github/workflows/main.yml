name: Android via VirtualBox
on: workflow_dispatch

jobs:
  virtualbox-android:
    runs-on: macos-latest # Required for VirtualBox support
    steps:
      - name: üåê Connect Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}

      - name: üõ†Ô∏è Install VirtualBox & Tools
        run: |
          # VirtualBox is usually pre-installed on macOS runners, 
          # but we ensure the command line tools are ready.
          vboxmanage --version

      - name: üíø Download Android-x86 ISO
        run: |
          curl -L -o android.iso https://osdn.net/projects/android-x86/downloads/71931/android-x86_64-9.0-r2.iso/

      - name: üèóÔ∏è Create VirtualBox VM
        run: |
          vboxmanage createvm --name "AndroidVM" --ostype "Linux26_64" --register
          vboxmanage modifyvm "AndroidVM" --memory 2048 --vram 128 --nic1 nat --graphicscontroller vmsvga
          vboxmanage storagectl "AndroidVM" --name "SATA" --add sata
          vboxmanage storageattach "AndroidVM" --storagectl "SATA" --port 0 --device 0 --type dvddrive --medium android.iso

      - name: ‚ö° Launch VM
        run: |
          vboxmanage startvm "AndroidVM" --type headless
          echo "VirtualBox VM started in headless mode."

      - name: üîí Start VNC Bridge
        run: |
          # VirtualBox has a built-in VRDE (Remote Desktop) 
          # We use a standard VNC server to bridge the macOS display
          # This part is complex on macOS; often it is easier to use
          # the standard emulator as it is optimized for this.
          
          TS_IP=$(tailscale ip -4)
          echo "=========================================="
          echo "  VM IP: $TS_IP"
          echo "  NOTE: macOS runners have no local display."
          echo "=========================================="
          sleep 3600
          

name: Stable Android VNC (Ubuntu)
on: workflow_dispatch

jobs:
  run-android:
    runs-on: ubuntu-latest
    env:
      ANDROID_AVD_HOME: /home/runner/.android/avd
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: ЁЯМР Connect Tailscale (Step-by-Step Fix)
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
          # tags ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж▓рзЗ ржХрж╛ржирзЗржХрж╢ржи ржЖрж░ржУ рж╕рзНржЯрзЗржмрж▓ рж╣рзЯ
          args: --hostname=ubuntu-android-runner

      - name: ЁЯЫая╕П Install Desktop Tools
        run: |
          sudo apt-get update
          # wmctrl ржПржмржВ x11vnc рж╕ржарж┐ржХ ржбрж┐рж╕ржкрзНрж▓рзЗрж░ ржЬржирзНржп ржЬрж░рзБрж░рж┐
          sudo apt-get install -y xvfb x11vnc fluxbox wmctrl

      - name: ЁЯУ▒ Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: тЪб Launch Fast Android (Software Graphics)
        run: |
          mkdir -p $ANDROID_AVD_HOME
          # Android 9 ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗ ржХрж╛рж░ржг ржПржЯрж┐ ржХржо рж░тАНрзНржпрж╛ржорзЗ ржнрж╛рж▓рзЛ ржЪрж▓рзЗ
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "system-images;android-28;default;x86_64"
          echo "no" | $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager create avd -n stable_emu -k "system-images;android-28;default;x86_64" --force
          
          # ржнрж╛рж░рзНржЪрзБржпрж╝рж╛рж▓ ржбрж┐рж╕ржкрзНрж▓рзЗ рж╕рзНржЯрж╛рж░рзНржЯ ржХрж░рж╛ (720x1280 ржлрзЛржирзЗрж░ ржЬржирзНржп ржкрж╛рж░ржлрзЗржХрзНржЯ)
          Xvfb :99 -screen 0 720x1280x16 &
          export DISPLAY=:99
          sleep 5
          fluxbox &

          # ржПржорзБрж▓рзЗржЯрж░ рж░рж╛ржи ржХрж░рж╛ (GPU рж╣рж┐рж╕рзЗржмрзЗ swiftshader_indirect ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗ ржпрж╛ ржлрзЗрж▓ ржХрж░ржмрзЗ ржирж╛)
          $ANDROID_HOME/emulator/emulator -avd stable_emu \
            -no-audio -no-boot-anim -gpu swiftshader_indirect -no-snapshot -memory 2048 -no-accel & 

      - name: ЁЯФТ VNC Connect & Info
        run: |
          # ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб рж╕рзЗржЯржЖржк
          mkdir -p ~/.vnc && x11vnc -storepasswd "android123" ~/.vnc/passwd
          export DISPLAY=:99
          # VNC рж╕рж╛рж░рзНржнрж╛рж░ рж╕рзНржЯрж╛рж░рзНржЯ
          x11vnc -rfbauth ~/.vnc/passwd -display :99 -forever -bg -rfbport 5900
          
          # ржХрж╛ржирзЗржХрж╢ржи ржбрж┐ржЯрзЗржЗрж▓рж╕ ржкрзНрж░рж┐ржирзНржЯ ржХрж░рж╛
          TS_IP=$(tailscale ip -4)
          echo "=========================================="
          echo "ЁЯМР TAILSCALE IP: $TS_IP"
          echo "ЁЯСд USER: runner"
          echo "ЁЯФС PASS: android123"
          echo "ЁЯФМ PORT: 5900"
          echo "=========================================="
          
          # ржпрждржХрзНрж╖ржг ржЖржкржирж┐ ржХрж╛ржирзЗржХрзНржЯрзЗржб ржерж╛ржХржмрзЗржи рждрждржХрзНрж╖ржг ржЕрзНржпрж╛ржХрж╢ржиржЯрж┐ ржЪрж╛рж▓рзБ ржерж╛ржХржмрзЗ
          echo "ржЕрзНржпрж╛ржирзНржбрзНрж░ржпрж╝рзЗржб ржмрзБржЯ рж╣рждрзЗ рзи-рзй ржорж┐ржирж┐ржЯ рж╕ржорзЯ рж▓рж╛ржЧрждрзЗ ржкрж╛рж░рзЗ..."
          $ANDROID_HOME/platform-tools/adb wait-for-device
          sleep 3600
          

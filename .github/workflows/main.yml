name: macOS VirtualBox Android (Tailscale AuthKey)
on: workflow_dispatch

jobs:
  android-vbox:
    runs-on: macos-latest
    steps:
      - name: üåê Connect Tailscale (Manual Setup)
        run: |
          # 1. Install Tailscale
          brew install tailscale
          
          # 2. Start Tailscale background service
          sudo tailscaled --tun=userspace-networking &
          sleep 5
          
          # 3. Authenticate with AuthKey
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --hostname=gh-macos-android

      - name: üíø Download Android ISO & Prep VirtualBox
        run: |
          # Download a lightweight Android-x86 ISO
          curl -L -o android.iso https://osdn.net/projects/android-x86/downloads/71931/android-x86_64-9.0-r2.iso/
          
          # Create VM
          VBoxManage createvm --name "AndroidVM" --ostype "Linux26_64" --register
          VBoxManage modifyvm "AndroidVM" --memory 2048 --vram 128 --nic1 nat --graphicscontroller vmsvga
          
          # Attach ISO
          VBoxManage storagectl "AndroidVM" --name "SATA" --add sata
          VBoxManage storageattach "AndroidVM" --storagectl "SATA" --port 0 --device 0 --type dvddrive --medium android.iso
          
          # Enable Remote Display (VRDE) for VNC
          # VRDE typically uses RDP protocols, so we bridge it to VNC port 5900
          VBoxManage modifyvm "AndroidVM" --vrde on --vrdeport 5900 --vrdeaddress 0.0.0.0

      - name: üöÄ Launch & Connection Info
        run: |
          # Start VM in headless mode (no window on server)
          VBoxManage startvm "AndroidVM" --type headless
          
          # Get the Tailscale IP
          TS_IP=$(tailscale ip -4)
          
          echo "===================================================="
          echo "üåê TAILSCALE IP: $TS_IP"
          echo "üîå PORT: 5900"
          echo "üîë NO PASSWORD SET (Leave blank or try 'android')"
          echo "===================================================="
          echo "‚ö†Ô∏è  ON FIRST CONNECT:"
          echo "You will see a Boot Menu. Use your VNC keyboard to"
          echo "select 'Live CD - Run Android-x86 without installation'"
          echo "===================================================="
          
          # Keep alive for 1 hour
          sleep 3600
          

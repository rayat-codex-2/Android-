name: Android Remote VNC (Visible Version)
on: workflow_dispatch

jobs:
  emulator:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: üåê Connect Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}

      - name: üõ†Ô∏è Install VNC & Window Manager
        run: |
          sudo apt-get update
          # added 'wmctrl' to force the emulator window to focus/maximize
          sudo apt-get install -y xvfb x11vnc fluxbox wmctrl 

      - name: üì± Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: ‚ö° Launch Emulator & Desktop
        run: |
          SDK_MANAGER=$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager
          AVD_MANAGER=$ANDROID_HOME/cmdline-tools/latest/bin/avdmanager
          EMULATOR=$ANDROID_HOME/emulator/emulator
          
          if [ ! -f "$SDK_MANAGER" ]; then
            SDK_MANAGER=$ANDROID_HOME/tools/bin/sdkmanager
            AVD_MANAGER=$ANDROID_HOME/tools/bin/avdmanager
          fi

          # 1. Install System Image
          $SDK_MANAGER "system-images;android-29;default;x86_64"
          echo "no" | $AVD_MANAGER create avd -n fast_emu -k "system-images;android-29;default;x86_64" --force
          
          # 2. Start Virtual Display
          Xvfb :99 -screen 0 1280x720x16 &
          export DISPLAY=:99
          sleep 2
          fluxbox & 

          # 3. Launch Android with "Visible" flags
          # We remove -no-window so it actually renders to Xvfb
          $EMULATOR -avd fast_emu \
            -no-audio \
            -no-boot-anim \
            -accel on \
            -gpu swiftshader_indirect \
            -no-snapshot \
            -screen touch \
            -memory 2048 &
          
          # 4. Wait for the window to appear and maximize it
          echo "Waiting for Emulator window..."
          sleep 10
          wmctrl -r "Android Emulator" -e 0,0,0,1280,720 || true

      - name: üîí Start VNC & Show Credentials
        run: |
          mkdir -p ~/.vnc
          x11vnc -storepasswd "android123" ~/.vnc/passwd
          export DISPLAY=:99
          x11vnc -rfbauth ~/.vnc/passwd -display :99 -forever -bg -rfbport 5900
          
          TS_IP=$(tailscale ip -4)
          echo "=========================================="
          echo "üöÄ CONNECTION DASHBOARD"
          echo "=========================================="
          echo "  üåê IP ADDRESS : $TS_IP"
          echo "  üë§ USERNAME   : runner"
          echo "  üîë PASSWORD   : android123"
          echo "  üîå PORT       : 5900"
          echo "=========================================="
          
          # Wait until Android is fully booted before finishing the log
          echo "Waiting for Android to reach Home Screen..."
          $ANDROID_HOME/platform-tools/adb wait-for-device
          while [ "$($ANDROID_HOME/platform-tools/adb shell getprop sys.boot_completed | tr -d '\r')" != "1" ]; do
            sleep 5
          done
          echo "‚úÖ BOOT COMPLETED! You can now use the UI."
          
          sleep 3600
          
